#!/bin/bash
ARGS=$(getopt --options vhc:o:n:p: --long "verbose,help,output-file:,wallet-name:,password:" -- "$@")
eval set -- "$ARGS"
verbose="false"
help="false"
count=1
output_file="addresses.txt"

wallet_name=""
wallet_password=""

while true; do
    case "$1" in
        -v|--verbose) verbose="true"; shift ;;
        -h|--help) help="true"; shift ;;
	-c) count="$2"; shift 2 ;;
	-o|--output-file) output_file="$2"; shift 2 ;;
	-n|--wallet-name) wallet_name="$2"; shift 2 ;;
	-p|--password) wallet_password="$2"; shift 2 ;;
        --) shift; break ;;
        *) printf "Unknown option %s\n" "$1"; exit 1 ;;
    esac
done

if [ "$help" = "true" ]; then
    echo "EXAMPLE: autogen -c 500 --output-file /home/admin/myWalletAddresses.txt -n ./moneroWalletFile -p Passw0rd"
    echo ""
    echo "Help information"
    echo "-h, --help: Show this help message"
    echo "-c, Specify a count value (Default: 1)"
    echo "-o, --output-file: Speficy a location and filename for the output, (Default: ./addresses.txt)"
    echo "-n, --wallet-name: Specify the location and filename of a monero wallet file (**Required)"
    echo "-p, --password: Specify the password for your monero wallet"
    exit 0
fi   

if [ -z "$wallet_name" ]; then
    echo "Wallet File Location must be specified with -n or --wallet-name"
    exit 1
fi


if [ -z "$output_file" ]; then
    echo "Output file must be specified"
    exit 1
fi

if [ -z "$wallet_password" ]; then
    echo "Please enter your Wallet Password: "
    read -s password
    echo
fi

wallet_output=$( 
   { 
       for ((i=1; i<=count; i++)); do 
               echo "address new" 
       done 
       echo "exit" 
} | monero-wallet-cli --log-file ""  --wallet-file "$wallet_name" --password "$wallet_password" 2>/dev/null)

if grep -qF "Error: Key file not found." <<< "$wallet_output"; then
    echo "Wallet key file not found." >&2
    exit 1
fi

if grep -qF "Error: failed to load wallet: invalid password" <<< "$wallet_output"; then
    echo "Password provided is invalid." >&2
    exit 1
fi

addresses=$(grep -oP '\d+\s+[A-Za-z0-9]{95}' <<< "$wallet_output" | awk '{print $2}')
printf '%s\n' "$addresses" >> "$output_file"
count=$(grep -c . <<< "$addresses")
echo "Generated $count subaddress(es) and append to $output_file."
exit 0

